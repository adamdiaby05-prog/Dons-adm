# Configuration Caddy pour Laravel avec HTTPS local
:80 {
    # Rediriger tout le trafic HTTP vers HTTPS
    redir https://{host}{uri}
}

:443 {
    # Activer le TLS avec un certificat auto-signé pour le développement local
    tls internal
    
    # Définir le répertoire racine
    root * /var/www/html/public
    
    # Activer la compression
    encode gzip zstd
    
    # Configuration pour PHP-FPM
    php_fastcgi app:9000 {
        # Configuration pour les timeouts
        transport fastcgi {
            dial_timeout 5s
            read_timeout 10s
            write_timeout 10s
        }
    }
    
    # Gérer les erreurs
    handle_errors {
        @503 expression {http.error.status_code} == 503
        respond @503 "Service temporarily unavailable" 503
    }
    
    # Protection des fichiers sensibles
    @sensitive {
        path .env *.log .git
    }
    respond @sensitive 404
    
    # Configuration pour les assets
    @static {
        path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    }
    header @static Cache-Control "public, max-age=31536000"
    
    # Headers de sécurité
    header {
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        X-XSS-Protection "1; mode=block"
        Referrer-Policy strict-origin-when-cross-origin
    }
    
    # Logging
    log {
        output file /var/log/caddy/access.log {
            roll_size 100mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
    }
}